<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>é›·è¾¾è®¾ç½®</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100%
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 10px;
        padding-bottom: calc(var(--footer-height) + env(safe-area-inset-bottom) + 16px);
        color: #333;
        position: relative
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, .95);
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, .1);
        backdrop-filter: blur(10px)
    }

    h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 300
    }

    .section {
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(255, 255, 255, .8);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, .05)
    }

    .section h2 {
        color: #2d3748;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 500;
        text-align: center
    }

    .form-group {
        margin-bottom: 20px
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 16px
    }

    input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #e2e8f0;
        outline: none;
        -webkit-appearance: none;
        margin: 10px 0
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .2)
    }

    input[type="range"]::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .2)
    }

    .range-value {
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        color: #667eea;
        margin-top: 5px
    }

    input[type="number"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color .3s ease
    }

    input[type="number"]:focus {
        border-color: #667eea;
        outline: none
    }

    select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        background-color: white;
        transition: border-color .3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px
    }

    select:focus {
        border-color: #667eea;
        outline: none
    }

    .upload-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: transform .2s ease;
        margin-bottom: 10px
    }

    .upload-btn:hover {
        transform: translateY(-2px)
    }

    .upload-btn:active {
        transform: translateY(0)
    }

    button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
        font-weight: 500;
        transition: transform .2s ease;
        flex: 1
    }

    button:hover {
        transform: translateY(-2px)
    }

    button:active {
        transform: translateY(0)
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .button-group button {
        flex: 0 1 140px; /* ä»¥å†…å®¹ä¸ºä¸»ï¼ŒåŸºç¡€å®½åº¦140pxï¼Œå¯è‡ªåŠ¨æ¢è¡Œåˆ°ä¸‹ä¸€è¡Œ */
        white-space: nowrap; /* é¿å…ä¸­æ–‡é€å­—æ¢è¡Œå¯¼è‡´å‚ç›´æ˜¾ç¤º */
        word-break: keep-all; /* ä¿æŒä¸­æ–‡è¯ç»„ä¸è¢«éšæ„æ–­å¼€ */
    }

    .ota-btn {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 12px rgba(253, 160, 133, 0.35);
    }

    .ota-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.05);
    }

    .ota-btn:active {
        transform: translateY(0);
        filter: brightness(0.95);
    }

    .audio-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px
    }

    .audio-controls button {
        flex: 1
    }

    :root {
        --footer-height: 64px;
    }

    .fixed-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px 16px;
        height: var(--footer-height);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(6px);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9998;
        display: flex;
        align-items: center;
    }

    .fixed-footer button {
        width: 100%;
        height: 44px;
    }

    .section:last-of-type {
        margin-bottom: calc(var(--footer-height) + 24px);
    }

    .success {
        color: #38a169;
        background: rgba(56, 161, 105, .1);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin: 10px 0
    }

    .error {
        color: #e53e3e;
        background: rgba(229, 62, 62, .1);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin: 10px 0
    }

    .hidden {
        display: none
    }

    #message {
        position: fixed !important;
        top: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 9999 !important;
        min-width: 300px;
        max-width: 500px;
        padding: 0;
        margin: 0;
        border: none;
        background: transparent;
        display: none;
        transition: all .3s ease
    }

    #message.show {
        display: block !important
    }

    #message .success, #message .error {
        padding: 12px 20px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
        margin: 0;
        border: none
    }

    #message .success {
        background: #4CAF50;
        color: white
    }

    #message .error {
        background: #f44336;
        color: white
    }

    @media (max-width: 480px) {
        .container {
            margin: 5px;
            padding: 15px
        }

        h1 {
            font-size: 24px
        }

        .section {
            padding: 15px
        }

    .button-group {
        flex-direction: column
    }

    button {
        margin: 5px 0
    }
}
    .radio-group { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .radio-option { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background-color .2s; margin-bottom: 0; }
    .radio-option:hover { background-color: rgba(0,0,0,.05); }
    .conditional-group { transition: opacity .3s, max-height .3s; overflow: hidden; }
    .conditional-group.hidden { opacity: 0; max-height: 0; margin: 0; padding: 0; }
    </style>
</head>
<body>
<div id="message"></div>
<div class="container"><h1>ğŸ¯ é›·è¾¾è®¾ç½®</h1>
    <div class="section"><h2>ğŸ“ åŸºç¡€è®¾ç½®</h2>
        <div class="form-group">
            <label for="detectionDistance">æ£€æµ‹è·ç¦»: <span id="detectionDistanceValue">45</span>m</label>
            <input type="range" id="detectionDistance" min="1" max="100" value="50" oninput="updateRangeValue('detectionDistance','detectionDistanceValue','m')">
        </div>
        <div class="form-group">
            <label for="detectionSpeed">æ£€æµ‹é€Ÿåº¦: <span id="detectionSpeedValue">10</span>
            km/h</label><input type="range" id="detectionSpeed" min="1" max="120" value="5" oninput="updateRangeValue('detectionSpeed','detectionSpeedValue','km/h')"></div>
        <div class="form-group">
            <label for="dangerDistance">å±é™©è·ç¦»: <span id="dangerDistanceValue">15</span> m</label>
            <input type="range" id="dangerDistance" min="1" max="30" value="20" oninput="updateRangeValue('dangerDistance','dangerDistanceValue','m')">
        </div>
        <div class="form-group">
            <label for="dangerSpeed">å±é™©é€Ÿåº¦: <span id="dangerSpeedValue">25</span>km/h</label>
            <input type="range" id="dangerSpeed" min="10" max="120" value="25" oninput="updateRangeValue('dangerSpeed','dangerSpeedValue','km/h')">
        </div>
    </div>
    <div class="section"><h2>ğŸ”Š éŸ³æ•ˆè®¾ç½®</h2>
        <div class="form-group">
            <label>éŸ³æ•ˆå¼€å…³:</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="audioEnabled" id="audioEnabledTrue" value="true" checked onchange="toggleAudioSettings()"> å¯ç”¨
                </label>
                <label class="radio-option">
                    <input type="radio" name="audioEnabled" id="audioEnabledFalse" value="false" onchange="toggleAudioSettings()"> ç¦ç”¨
                </label>
            </div>
        </div>
        <div id="audioSettingsContainer">
            <div class="form-group">
                <label for="warningGain">éŸ³æ•ˆéŸ³é‡: <span id="warningGainValue">2.5</span></label>
                <input type="range" id="warningGain" min="0" max="3.5" step="0.1" value="2.5" oninput="updateRangeValue('warningGain','warningGainValue','')">
            </div>
            <div class="form-group">
                <label>è¾“å‡ºæ–¹å¼:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="audioI2S" id="audioI2STrue" value="true" checked> I2S
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="audioI2S" id="audioI2SFalse" value="false"> å–‡å­
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>æ™®é€šéŸ³æ•ˆ:</label>
                <input type="file" id="normalAudioFile" accept=".mp3" class="hidden" onchange="uploadAudioFile('normal')">
                <div class="audio-controls">
                    <button type="button" class="upload-btn" onclick="document.getElementById('normalAudioFile').click()">ğŸ“ä¸Šä¼ éŸ³æ•ˆ</button>
                    <button type="button" class="upload-btn" onclick="playAudio('normal')">ğŸ”Š è¯•å¬</button>
                </div>
                <div id="normalAudioStatus"></div>
            </div>
            <div class="form-group">
                <label>å±é™©éŸ³æ•ˆ:</label>
                <input type="file" id="dangerAudioFile" accept=".mp3" class="hidden" onchange="uploadAudioFile('danger')">
                <div class="audio-controls">
                    <button type="button" class="upload-btn" onclick="document.getElementById('dangerAudioFile').click()">ğŸ“ä¸Šä¼ éŸ³æ•ˆ</button>
                    <button type="button" class="upload-btn" onclick="playAudio('danger')">ğŸ”Š è¯•å¬</button>
                </div>
                <div id="dangerAudioStatus"></div>
            </div>
            <div class="form-group">
                <label>å·¦åæ–¹éŸ³æ•ˆ:</label>
                <input type="file" id="leftAudioFile" accept=".mp3" class="hidden" onchange="uploadAudioFile('left')">
                <div class="audio-controls">
                    <button type="button" class="upload-btn" onclick="document.getElementById('leftAudioFile').click()">ğŸ“ä¸Šä¼ éŸ³æ•ˆ</button>
                    <button type="button" class="upload-btn" onclick="playAudio('left')">ğŸ”Š è¯•å¬</button>
                </div>
                <div id="leftAudioStatus"></div>
            </div>
            <div class="form-group">
                <label>å³åæ–¹éŸ³æ•ˆ:</label>
                <input type="file" id="rightAudioFile" accept=".mp3" class="hidden" onchange="uploadAudioFile('right')">
                <div class="audio-controls">
                    <button type="button" class="upload-btn" onclick="document.getElementById('rightAudioFile').click()">ğŸ“ä¸Šä¼ éŸ³æ•ˆ</button>
                    <button type="button" class="upload-btn" onclick="playAudio('right')">ğŸ”Š è¯•å¬</button>
                </div>
                <div id="rightAudioStatus"></div>
            </div>
            <div class="form-group">
                <label>æ­£åæ–¹éŸ³æ•ˆ:</label>
                <input type="file" id="rearAudioFile" accept=".mp3" class="hidden" onchange="uploadAudioFile('rear')">
                <div class="audio-controls">
                    <button type="button" class="upload-btn" onclick="document.getElementById('rearAudioFile').click()">ğŸ“ä¸Šä¼ éŸ³æ•ˆ</button>
                    <button type="button" class="upload-btn" onclick="playAudio('rear')">ğŸ”Š è¯•å¬</button>
                </div>
                <div id="rearAudioStatus"></div>
            </div>
        </div>
    </div>
    <div class="section"><h2>ğŸ’¡ ç¯å…‰è®¾ç½®</h2>
        <div class="form-group">
            <label>ç¯å…‰æ¨¡å¼:</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="lightBlink" id="lightModeConstant" value="false" onchange="toggleBlinkSettings()"> å¸¸äº®
                </label>
                <label class="radio-option">
                    <input type="radio" name="lightBlink" id="lightModeBlink" value="true" checked onchange="toggleBlinkSettings()"> é—ªçƒ
                </label>
            </div>
        </div>
        <div id="blinkDurationGroup" class="form-group" style="display:none">
            <label id="blinkDurationLabel" for="blinkDuration">é—ªçƒæ—¶é•¿: <span id="blinkDurationValue">2</span> ç§’</label>
            <input type="range" id="blinkDuration" min="1" max="5" value="2" step="1" oninput="updateRangeValue('blinkDuration','blinkDurationValue','ç§’')">
        </div>
        <div id="blinkSettingsContainer" style="display:none">
            <div class="form-group">
                <label for="normalBlinkInterval">æ™®é€šé¢‘ç‡ (ms):</label>
                <input type="number" id="normalBlinkInterval" min="100" max="2000" value="800">
            </div>
            <div class="form-group"><label for="dangerBlinkInterval">å±é™©é¢‘ç‡ (ms):</label>
                <input type="number" id="dangerBlinkInterval" min="50" max="1000" value="120">
            </div>
        </div>
    </div>
    <div class="section">
        <h2>ğŸ“ è§’åº¦è®¾ç½®</h2>
        <div class="form-group">
            <label>ç¯å…‰è§’åº¦:</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="lightAngle" id="lightAngleDirectional" value="true" checked onchange="toggleAngleOptions()"> æŒ‡ç¤ºå·¦å³
                </label>
                <label class="radio-option">
                    <input type="radio" name="lightAngle" id="lightAngleBoth" value="false" onchange="toggleAngleOptions()"> å·¦å³åŒäº®
                </label>
            </div>
        </div>
        <div id="centerAngleGroup" class="form-group">
            <label for="centerAngle">æ­£åæ–¹è§’åº¦(Â±): <span id="centerAngleValue">5</span> Â°</label>
            <input type="range" id="centerAngle" min="0" max="5" value="5" step="1" oninput="updateRangeValue('centerAngle','centerAngleValue','Â°')">
        </div>
    </div>
        <div class="section">
            <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            <div class="form-group" style="margin-top:4px;">
                <div class="button-group">
                    <button type="button" onclick="triggerTest('normal')">ğŸ”” æ™® é€š é¢„ è­¦</button>
                    <button type="button" onclick="triggerTest('danger')">âš ï¸ å± é™© é¢„ è­¦</button>
                    <button type="button" onclick="triggerTest('left')">â¬…ï¸ å·¦åæ–¹æ¥è½¦</button>
                    <button type="button" onclick="triggerTest('rear')">â¬†ï¸ æ­£åæ–¹æ¥è½¦</button>
                    <button type="button" onclick="triggerTest('right')">â¡ï¸ å³åæ–¹æ¥è½¦</button>
                </div>
            </div>
        </div>
    <div class="section">
        <h2>ğŸ“¦ å›ºä»¶æ›´æ–°</h2>
        <div class="form-group">
            <label>å›ºä»¶ç‰ˆæœ¬: <span id="firmwareVersionValue">åŠ è½½ä¸­...</span></label>
        </div>
        <div class="form-group">
            <label>æ„å»ºæ—¶é—´:<span id="firmwareBuildTimeValue">åŠ è½½ä¸­...</span></label>
        </div>
        <div class="form-group">
            <label>å›ºä»¶ç±»å‹:</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="firmwareType" id="firmwareTypeProgram" value="flash" checked> ç¨‹åº
                </label>
                <label class="radio-option">
                    <input type="radio" name="firmwareType" id="firmwareTypeFiles" value="fs"> æ–‡ä»¶
                </label>
            </div>
        </div>
        <input type="file" id="firmwareFile" accept=".bin" class="hidden">
        <div class="button-group">
            <button class="ota-btn" onclick="selectAndUploadFirmware()">ğŸ“¤ é€‰æ‹©å›ºä»¶</button>
        </div>
        <div id="otaProgress" class="range-value" style="text-align:left;color:#4a5568;"></div>
    </div>
</div>
<div class="fixed-footer">
    <button onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
</div>
<script>
    function updateRangeValue(sliderId, valueId, unit) {
        const slider = document.getElementById(sliderId);
        const valueSpan = document.getElementById(valueId);
        valueSpan.textContent = slider.value
    }

    function uploadAudioFile(type) {
        const fileInput = document.getElementById(type + 'AudioFile');
        const file = fileInput.files[0];
        if (!file) {
            return
        }
        const formData = new FormData();
        const nameMap = {
            normal: 'normal.mp3',
            danger: 'danger.mp3',
            left: 'left.mp3',
            right: 'right.mp3',
            rear: 'rear.mp3'
        };
        const fileName = nameMap[type] || 'normal.mp3';
        formData.append('file', file, fileName);
        const statusDiv = document.getElementById(type + 'AudioStatus');
        statusDiv.innerHTML = '<div class="success">æ­£åœ¨ä¸Šä¼ ...</div>';
        fetch('/upload', {method: 'POST', body: formData}).then(response => response.text()).then(data => {
            statusDiv.innerHTML = '<div class="success">âœ… ä¸Šä¼ æˆåŠŸ</div>';
            setTimeout(() => {
                statusDiv.innerHTML = ''
            }, 3000)
        }).catch(error => {
            statusDiv.innerHTML = '<div class="error">âŒ ä¸Šä¼ å¤±è´¥: ' + error + '</div>'
        })
    }

    async function saveConfig() {
        const config = {
            detectionDistance: parseInt(document.getElementById('detectionDistance').value),
            detectionSpeed: parseInt(document.getElementById('detectionSpeed').value),
            dangerDistance: parseInt(document.getElementById('dangerDistance').value),
            dangerSpeed: parseInt(document.getElementById('dangerSpeed').value),
            lightBlink: document.getElementById('lightModeBlink').checked,
            blinkDuration: parseFloat(document.getElementById('blinkDuration').value),
            normalBlinkInterval: parseInt(document.getElementById('normalBlinkInterval').value),
            dangerBlinkInterval: parseInt(document.getElementById('dangerBlinkInterval').value),
            warningGain: parseFloat(document.getElementById('warningGain').value),
            audioEnabled: document.getElementById('audioEnabledTrue').checked,
            audioI2S: document.getElementById('audioI2STrue').checked,
            lightAngle: document.getElementById('lightAngleDirectional').checked,
            centerAngle: parseInt(document.getElementById('centerAngle').value)
        };
        try {
            const response = await fetch('/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json',},
                body: JSON.stringify(config)
            });
            if (!response.ok) throw new Error();
            showMessage('âœ… é…ç½®ä¿å­˜æˆåŠŸ', 'success')
        } catch (e) {
            showMessage('âŒ é…ç½®ä¿å­˜å¤±è´¥', 'error')
        }
    }

    async function loadConfig() {
        try {
            const response = await fetch('/config');
            if (!response.ok) throw new Error();
            const config = await response.json();
            document.getElementById('detectionDistance').value = config.detectionDistance || 50;
            document.getElementById('detectionSpeed').value = config.detectionSpeed || 5;
            document.getElementById('dangerDistance').value = config.dangerDistance || 20;
            document.getElementById('dangerSpeed').value = config.dangerSpeed || 25;
            const lightMode = !!(config.lightBlink || false);
            document.getElementById('lightModeBlink').checked = lightMode;
            document.getElementById('lightModeConstant').checked = !lightMode;
            document.getElementById('blinkDuration').value = (config.blinkDuration !== undefined ? config.blinkDuration : 2);
            document.getElementById('normalBlinkInterval').value = config.normalBlinkInterval || 800;
            document.getElementById('dangerBlinkInterval').value = config.dangerBlinkInterval || 120;
            document.getElementById('warningGain').value = config.warningGain || 3.5;
            const audioEnabled = (config.audioEnabled !== undefined ? config.audioEnabled : true);
            document.getElementById('audioEnabledTrue').checked = !!audioEnabled;
            document.getElementById('audioEnabledFalse').checked = !audioEnabled;
            const audioI2S = (config.audioI2S !== undefined ? config.audioI2S : true);
            document.getElementById('audioI2STrue').checked = !!audioI2S;
            document.getElementById('audioI2SFalse').checked = !audioI2S;
            const lightAngleDirectional = (config.lightAngle !== undefined ? config.lightAngle : true);
            document.getElementById('lightAngleDirectional').checked = !!lightAngleDirectional;
            document.getElementById('lightAngleBoth').checked = !lightAngleDirectional;
            document.getElementById('centerAngle').value = (config.centerAngle !== undefined ? config.centerAngle : 5);
            updateRangeValue('detectionDistance', 'detectionDistanceValue', 'm');
            updateRangeValue('detectionSpeed', 'detectionSpeedValue', 'km/h');
            updateRangeValue('dangerDistance', 'dangerDistanceValue', 'm');
            updateRangeValue('dangerSpeed', 'dangerSpeedValue', 'km/h');
            updateRangeValue('warningGain', 'warningGainValue', '');
            updateRangeValue('blinkDuration','blinkDurationValue','ç§’');
            updateRangeValue('centerAngle','centerAngleValue','Â°');
            toggleBlinkSettings();
            toggleAudioSettings();
            toggleAngleOptions();
            showMessage('âœ… é…ç½®åŠ è½½æˆåŠŸ', 'success')
        } catch (e) {
            showMessage('âŒ é…ç½®åŠ è½½å¤±è´¥', 'error')
        }
    }

    function toggleBlinkSettings() {
        const lightMode = document.getElementById('lightModeBlink').checked;
        document.getElementById('blinkSettingsContainer').style.display = lightMode ? 'block' : 'none';
        const labelEl = document.getElementById('blinkDurationLabel');
        const durationValue = document.getElementById('blinkDuration').value;
        if (labelEl) {
            labelEl.innerHTML = `${lightMode ? 'é—ªçƒæ—¶é•¿' : 'äº®ç¯æ—¶é•¿'}: <span id="blinkDurationValue">${durationValue}</span> ç§’`;
        }
    }

    function toggleAngleOptions() {
        const directional = document.getElementById('lightAngleDirectional').checked;
        const centerGroup = document.getElementById('centerAngleGroup');
        if (directional) {
            centerGroup.classList.remove('hidden');
        } else {
            centerGroup.classList.add('hidden');
        }
    }

    function toggleAudioSettings() {
        const audioEnabled = document.getElementById('audioEnabledTrue').checked;
        document.getElementById('audioSettingsContainer').style.display = audioEnabled ? 'block' : 'none';
        const blinkDurationGroup = document.getElementById('blinkDurationGroup');
        if (blinkDurationGroup) {
            blinkDurationGroup.style.display = audioEnabled ? 'none' : 'block';
        }
    }

    function playAudio(type) {
        const timestamp = new Date().getTime();
        const nameMap = {
            normal: 'normal.mp3',
            danger: 'danger.mp3',
            left: 'left.mp3',
            right: 'right.mp3',
            rear: 'rear.mp3'
        };
        const labelMap = {
            normal: 'æ™®é€š',
            danger: 'å±é™©',
            left: 'å·¦åæ–¹',
            right: 'å³åæ–¹',
            rear: 'æ­£åæ–¹'
        };
        const fileName = nameMap[type] || 'normal.mp3';
        const audioUrl = `/${fileName}?t=${timestamp}`;
        const audio = new Audio(audioUrl);
        audio.play().then(() => {
            const label = labelMap[type] || 'æ™®é€š';
            showMessage(`ğŸ”Š æ­£åœ¨æ’­æ”¾${label}éŸ³æ•ˆ`, 'success')
        }).catch(error => {
            const label = labelMap[type] || 'æ™®é€š';
            showMessage(`âŒ æ’­æ”¾${label}éŸ³æ•ˆå¤±è´¥`, 'error')
        })
    }

    async function triggerTest(type) {
        try {
            const res = await fetch(`/test/${type}`, {method: 'GET', cache: 'no-store'});
            if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
            const text = await res.text();
            showMessage(`âœ… ${text}`, 'success');
        } catch (e) {
            showMessage('âŒ æµ‹è¯•è§¦å‘å¤±è´¥', 'error');
        }
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        messageDiv.classList.add('show');
        setTimeout(() => {
            messageDiv.classList.remove('show');
            setTimeout(() => {
                messageDiv.innerHTML = ''
            }, 300)
        }, 3000)
    }

    async function selectAndUploadFirmware() {
        const input = document.getElementById('firmwareFile');
        input.value = '';
        input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.bin')) {
                document.getElementById('otaProgress').innerText = 'è¯·é€‰æ‹© .bin å›ºä»¶æ–‡ä»¶';
                return;
            }
            await uploadFirmwareFile(file);
            // ä¸Šä¼ ç»“æŸåå°è¯•åˆ·æ–°ç‰ˆæœ¬ï¼ˆè®¾å¤‡å°†é‡å¯ï¼Œå¼€å¯è½®è¯¢æ£€æµ‹ï¼‰
            await pollVersionUntil(30000, 2000);
        };
        input.click();
    }

    async function uploadFirmwareFile(file) {
        const progressEl = document.getElementById('otaProgress');
        progressEl.innerText = 'å¼€å§‹ä¸Šä¼ å›ºä»¶...';
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const type = document.getElementById('firmwareTypeFiles').checked ? 'fs' : 'flash';
            xhr.open('POST', `/update?firmwareType=${encodeURIComponent(type)}`, true);
            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressEl.innerText = `ä¸Šä¼ è¿›åº¦ï¼š${percent}%`;
                }
            };
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const msgType = type === 'fs' ? 'æ–‡ä»¶ç³»ç»Ÿ' : 'ç¨‹åºå›ºä»¶';
                    progressEl.innerText = `æ›´æ–°${msgType}æˆåŠŸï¼Œè®¾å¤‡å°†é‡å¯...æ­£åœ¨ç­‰å¾…è®¾å¤‡æ¢å¤`;
                    resolve();
                } else {
                    progressEl.innerText = `æ›´æ–°å¤±è´¥ï¼š${xhr.responseText || xhr.status}`;
                    reject(new Error('OTA failed'));
                }
            };
            xhr.onerror = () => {
                progressEl.innerText = 'ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥';
                reject(new Error('Network error'));
            };
            xhr.send(file);
        });
    }

    async function fetchAndShowVersion() {
        const verEl = document.getElementById('firmwareVersionValue');
        const timeEl = document.getElementById('firmwareBuildTimeValue');
        try {
            const res = await fetch('/version');
            if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
            const data = await res.json();
            const __d1 = new Date(data.buildTime);
            const __pad1 = n => String(n).padStart(2, '0');
            const __fmt1 = isNaN(__d1.getTime()) ? data.buildTime : `${__d1.getFullYear()}-${__pad1(__d1.getMonth() + 1)}-${__pad1(__d1.getDate())} ${__pad1(__d1.getHours())}:${__pad1(__d1.getMinutes())}:${__pad1(__d1.getSeconds())}`;
            verEl.textContent = data.version || 'æœªçŸ¥';
            timeEl.textContent = __fmt1 || 'æœªçŸ¥';
            return true;
        } catch (e) {
            if (verEl) verEl.textContent = 'è·å–å¤±è´¥';
            if (timeEl) timeEl.textContent = 'è·å–å¤±è´¥';
            return false;
        }
    }

    async function pollVersionUntil(timeoutMs = 30000, intervalMs = 2000) {
        const start = Date.now();
        const progressEl = document.getElementById('otaProgress');
        while (Date.now() - start < timeoutMs) {
            try {
                const res = await fetch('/version', {cache: 'no-store'});
                if (res.ok) {
                    const data = await res.json();
                    const __d2 = new Date(data.buildTime);
                    const __pad2 = n => String(n).padStart(2, '0');
                    const __fmt2 = isNaN(__d2.getTime()) ? data.buildTime : `${__d2.getFullYear()}-${__pad2(__d2.getMonth() + 1)}-${__pad2(__d2.getDate())} ${__pad2(__d2.getHours())}:${__pad2(__d2.getMinutes())}:${__pad2(__d2.getSeconds())}`;
                    const verEl = document.getElementById('firmwareVersionValue');
                    const timeEl = document.getElementById('firmwareBuildTimeValue');
                    if (verEl) verEl.textContent = data.version || 'æœªçŸ¥';
                    if (timeEl) timeEl.textContent = __fmt2 || 'æœªçŸ¥';
                    progressEl.innerText = 'è®¾å¤‡å·²é‡å¯ï¼Œè¯·é‡æ–°è¿æ¥è®¾å¤‡WiFiçƒ­ç‚¹';
                    return true;
                }
            } catch (e) {
                // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­é‡è¯•
            }
            await new Promise(r => setTimeout(r, intervalMs));
        }
        progressEl.innerText = 'ç­‰å¾…è®¾å¤‡æ¢å¤è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨è¿åˆ·æ–°é¡µé¢';
        return false;
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetchAndShowVersion();
    });

    window.onload = function () {
        loadConfig()
    };
</script>
</body>
</html>